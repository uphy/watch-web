{{ define "add" }}
{
    "color": "#0000FF",
    "blocks": [
        {
            "type": "section",
            "text": {
                "type": "mrkdwn",
                "text": "*[Add]* <{{ .link }}|{{ .summary | escape}}>\n{{ .description | escape }}"
            }
        },
        {
            "type": "section",
            "fields": [
                {{ range $index, $elm := (toArrayExcludes . "link" "summary" "description" "thumbnail" "__id__") }}
                {{     if not (eq $index 0) }},{{ end }}
                {
                    "type": "mrkdwn",
                    "text": "*{{ $elm.key | escape }}:*\n{{ $elm.value | escape }}"
                }
                {{ end }}
            ]
        },
        {{ if .thumbnail }}
        {
            "type": "image",
            "image_url": "{{ .thumbnail }}",
            "alt_text": "{{ .summary | escape}}"
        },
        {{ end }}
        {
            "type": "divider"
        }
    ]
}
{{ end }}
{{ define "remove" }}
{
    "color": "#FF0000",
    "blocks": [
        {
            "type": "section",
            "text": {
                "type": "mrkdwn",
                "text": "*[Remove]* <{{ .link }}|~{{ .summary | escape }}~>\n~{{ .description | escape }}~"
            }
        },
        {
            "type": "divider"
        }
    ]
}
{{ end }}
{{ define "change" }}
{
    "color": "#FFFF00",
    "blocks": [
        {
            "type": "section",
            "text": {
                "type": "mrkdwn",
                "text": "*[Change]* <{{ .Item.link }}|{{ .Item.summary | escape }}>\n{{ .Item.description | escape}}"
            }
        },
        {
            "type": "section",
            "fields": [
                {{ range $index, $elm := (flatChanges .) }}
                {{   if not (eq $index 0) }},{{ end }}
                {{   if eq $elm.type "add" }}
                {
                    "type": "mrkdwn",
                    "text": "*{{ $elm.key | escape }}:*\n{{ $elm.value | escape}}"
                }
                {{   else if eq $elm.type "remove" }}
                {
                    "type": "mrkdwn",
                    "text": "~{{ $elm.key | escape }}~:\n~{{ $elm.value | escape }}~"
                }
                {{   else if eq $elm.type "change" }}
                {
                    "type": "mrkdwn",
                    "text": "*{{ $elm.key | escape }}:*\n~{{ $elm.value.Old | escape }}~ -> {{ $elm.value.New | escape }}"
                }
                {{   end }}
                {{ end }}
            ]
        },
        {{ if .Item.thumbnail }}
        {
            "type": "image",
            "image_url": "{{ .Item.thumbnail }}",
            "alt_text": "{{ .Item.summary | escape }}"
        },
        {{ end }}
        {
            "type": "divider"
        }
    ]
}
{{ end }}
{
    "text": "<!channel> <{{ .res.Link }}|{{ .res.Label | escape }}> has been updated",
    "blocks": [],
    "attachments": [
        {{ range $index, $update := .updates }}
        {{   if $index }},{{ end }}
        {{   if (eq $update.Type "change") }}
        {{     template "change" $update.Change }}
        {{   else if (eq $update.Type "add") }}
        {{     template "add" $update.Add }}
        {{   else if (eq $update.Type "remove") }}
        {{     template "remove" $update.Remove }}
        {{   end }}
        {{ end }}
    ]
}