source:
  # シェルコマンドを実行する。実行結果は文字列になる。
  constant:
    template: "{{ .current }}"
  # sourceを変換するフィルタ定義。0個以上指定可能。
  transforms:
    # sourceは文字列なので、json arrayに変換する。
    - json_array: {}
    # json arrayの各要素をtransformによって変換する。
    - json_transform:
        transform:
          summary: '{{ .source.name }}({{ .source.type }})'
          description: |
            {{- with .source }}
            {{- .rent }}
            {{-  if .system }}(
            {{-    range $index, $s := .system }}
            {{-      if $index }}, {{end}}
            {{-      $s.制度名 }}
            {{-    end }})
            {{-  end -}}
            [共益費 {{ .commonfee }}{{ if .rent_normal }}, 通常 {{ .rent_normal }}{{ end }}]
            {{- end -}}
          link: 'https://www.ur-net.go.jp/{{ .source.roomDetailLinkSp }}'
          thumbnail: '{{ .source.madori }}'
          "制度": |
            {{-  if .source.system }}
            {{-    range $index, $s := .source.system }}
            {{-      if $index }}, {{end}}
            {{-      $s.制度名 }}
            {{-    end }}
            {{-  end -}}
          "敷金": '{{ .source.shikikin }}'
          "間取り": '{{ .source.type }}'
          "平米数": '{{ .source.floorspace | match "(\\d+).*" }}㎡'
          "階数": '{{ .source.floor }} / {{ .source.floorAll }}'
    # サーバー側で順序が変わっても対応できるように、配列要素をsummaryでソート
    - json_array_sort:
        by: summary
tests:
  - name: New row added
    vars:
      current: |
        [{"pageIndex":"0","rowMax":"5","rowMaxSp":"3","rowMaxNext":"10","pageMax":"5","allCount":"1","block":"kanto","tdfk":"tokyo","shisya":"20","danchi":"688","shikibetu":"0","floorAll":"9階","roomDetailLink":"/chintai/kanto/tokyo/20_6880_room.html?JKSS=000070406","roomDetailLinkSp":"/chintai/sp/kanto/tokyo/20_6880_room.html?JKSS=000070406","system":[{"制度_IMG":"btn_kosodate.png","制度名":"子育て割","制度HTML":"kosodate"}],"parking":null,"design":[],"featureParam":[],"traffic":null,"place":null,"kanris":null,"kouzou":null,"soukosu":null,"id":"000070406","year":null,"name":"7号棟406号室","shikikin":"2か月","requirement":"ナシ","madori":"https://chintai.sumai.ur-net.go.jp/chintai/img_madori/20/20_688/20_688_0-00-0007_Nw_RA_01_00003.gif","rent":"74,800円","rent_normal":"93,500円","rent_normal_css":"","commonfee":"4,700円","commonfee_sp":null,"status":null,"type":"2DK","floorspace":"50&#13217;","floor":"4階","urlDetail":null,"urlDetail_sp":null,"feature":null}]
    previous: "[]"
    expects:
      result: |
        [{"description":"74,800円(子育て割)[共益費 4,700円, 通常 93,500円]","link":"https://www.ur-net.go.jp//chintai/sp/kanto/tokyo/20_6880_room.html?JKSS=000070406","summary":"7号棟406号室(2DK)","thumbnail":"https://chintai.sumai.ur-net.go.jp/chintai/img_madori/20/20_688/20_688_0-00-0007_Nw_RA_01_00003.gif","制度":"子育て割","平米数":"50㎡","敷金":"2か月","間取り":"2DK","階数":"4階 / 9階"}]
      diff: |
        + {"description":"74,800円(子育て割)[共益費 4,700円, 通常 93,500円]","link":"https://www.ur-net.go.jp//chintai/sp/kanto/tokyo/20_6880_room.html?JKSS=000070406","summary":"7号棟406号室(2DK)","thumbnail":"https://chintai.sumai.ur-net.go.jp/chintai/img_madori/20/20_688/20_688_0-00-0007_Nw_RA_01_00003.gif","制度":"子育て割","平米数":"50㎡","敷金":"2か月","間取り":"2DK","階数":"4階 / 9階"}
